<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Intelligence Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .enemy-row { border-left: 4px solid #f43f5e; }
        .ally-row { border-left: 4px solid #10b981; }
    </style>
</head>
<body x-data="warRoom()" x-init="init()">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-80 glass p-6 flex flex-col gap-6 shadow-2xl border-r border-slate-800">
            <div>
                <h1 class="text-3xl font-black tracking-tighter text-cyan-500 italic">INTEL_HUB</h1>
                <p class="text-[10px] text-slate-500 font-mono tracking-widest uppercase">Cross-Server Analytics</p>
            </div>

            <!-- Global Filters -->
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Your Alliance</label>
                    <select x-model="myAllianceName" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl mt-1 text-white text-sm focus:ring-2 focus:ring-cyan-500 outline-none">
                        <option value="">-- Select Your Alliance --</option>
                        <template x-for="a in alliances.filter(i => i.Faction === 'Ally')">
                            <option :value="a.AllianceName" x-text="`[S${a.Server}] ${a.AllianceName}`"></option>
                        </template>
                    </select>
                </div>

                <nav class="flex flex-col gap-2 pt-4">
                    <button @click="tab = 'matches'" :class="tab === 'matches' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:bg-slate-800'" class="w-full text-left p-3 rounded-lg transition font-bold text-sm">Alliance Matchups</button>
                    <button @click="tab = 'players'" :class="tab === 'players' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:bg-slate-800'" class="w-full text-left p-3 rounded-lg transition font-bold text-sm">Elite Player Intel (Top 200)</button>
                </nav>
            </div>

            <div class="mt-auto border-t border-slate-800 pt-4">
                <button @click="fetchData()" class="w-full py-2 text-[10px] font-bold bg-slate-800 hover:bg-slate-700 rounded text-slate-400">SYNC LIVE DATA</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            
            <!-- VIEW: ALLIANCE MATCHUPS -->
            <div x-show="tab === 'matches'" x-cloak>
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-4xl font-black">ALLIANCE TARGETING</h2>
                        <p class="text-slate-400">Comparing enemy power across all 4 servers.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <!-- If alliance selected, show "Fair Match" logic -->
                    <template x-for="enemy in sortedEnemies">
                        <div class="glass p-5 rounded-xl enemy-row flex items-center justify-between group hover:bg-slate-800/40 transition">
                            <div class="flex items-center gap-6">
                                <div class="w-12 h-12 rounded-lg bg-slate-900 flex items-center justify-center border border-slate-700">
                                    <span class="text-xs font-bold text-slate-500" x-text="'S' + enemy.Server"></span>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold group-hover:text-cyan-400 transition" x-text="enemy.AllianceName"></h3>
                                    <p class="text-xs text-slate-500 uppercase tracking-wider" x-text="'Power: ' + Number(enemy.TotalPower).toLocaleString()"></p>
                                </div>
                            </div>

                            <div class="flex items-center gap-8">
                                <!-- Match Difficulty Indicator -->
                                <template x-if="myAllianceName">
                                    <div class="text-right">
                                        <div class="text-[10px] text-slate-500 uppercase font-bold">Matchup</div>
                                        <div :class="getMatchColor(enemy)" class="text-sm font-black" x-text="calculateMatch(enemy)"></div>
                                    </div>
                                </template>
                                <div class="text-right">
                                    <div class="text-[10px] text-slate-500 uppercase font-bold">Threat Level</div>
                                    <div class="text-sm text-white font-mono" x-text="getThreat(enemy)"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- VIEW: TOP PLAYERS -->
            <div x-show="tab === 'players'" x-cloak>
                <div class="mb-8">
                    <h2 class="text-4xl font-black uppercase">Elite Intel</h2>
                    <p class="text-slate-400 font-mono text-sm tracking-tighter">Global Ranking by Total Hero Power (THP)</p>
                </div>

                <div class="glass rounded-2xl overflow-hidden shadow-2xl border border-slate-800">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-900/50 text-slate-500 text-[10px] uppercase tracking-widest border-b border-slate-800">
                                <th class="p-4">Rank</th>
                                <th class="p-4">Player</th>
                                <th class="p-4">Alliance</th>
                                <th class="p-4">Server</th>
                                <th class="p-4 text-right">THP</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            <template x-for="(p, index) in topPlayers">
                                <tr class="hover:bg-cyan-500/5 transition group" :class="p.Faction === 'Enemy' ? 'enemy-row' : 'ally-row'">
                                    <td class="p-4 text-slate-600 font-mono text-xs" x-text="index + 1"></td>
                                    <td class="p-4 font-bold text-slate-200" x-text="p.PlayerName"></td>
                                    <td class="p-4 text-sm text-slate-400" x-text="p.AllianceName"></td>
                                    <td class="p-4">
                                        <span class="px-2 py-0.5 rounded bg-slate-900 text-[10px] text-slate-400 border border-slate-700" x-text="'Server ' + p.Server"></span>
                                    </td>
                                    <td class="p-4 text-right font-mono text-cyan-400 font-bold" x-text="Number(p.THP).toLocaleString()"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        function warRoom() {
            return {
                tab: 'matches',
                // Replace these with your TWO separate CSV export links from Google Sheets
                sheetAlliancesURL: 'LINK_TO_ALLIANCES_CSV',
                sheetPlayersURL: 'LINK_TO_PLAYERS_CSV',
                
                alliances: [],
                players: [],
                myAllianceName: '',

                async init() {
                    await this.fetchData();
                },

                async fetchData() {
                    const nocache = `&t=${Date.now()}`;
                    
                    // Fetch Alliances
                    Papa.parse(this.sheetAlliancesURL + nocache, {
                        download: true, header: true,
                        complete: (res) => { this.alliances = res.data; }
                    });

                    // Fetch Players
                    Papa.parse(this.sheetPlayersURL + nocache, {
                        download: true, header: true,
                        complete: (res) => { this.players = res.data; }
                    });
                },

                get myAlliance() {
                    return this.alliances.find(a => a.AllianceName === this.myAllianceName);
                },

                get sortedEnemies() {
                    let enemies = this.alliances.filter(a => a.Faction === 'Enemy');
                    if (this.myAlliance) {
                        // Sort by how close they are to your power (Ideal targets)
                        return enemies.sort((a, b) => {
                            return Math.abs(a.TotalPower - this.myAlliance.TotalPower) - 
                                   Math.abs(b.TotalPower - this.myAlliance.TotalPower);
                        });
                    }
                    return enemies.sort((a,b) => b.TotalPower - a.TotalPower);
                },

                get topPlayers() {
                    return [...this.players].sort((a,b) => b.THP - a.THP).slice(0, 200);
                },

                calculateMatch(enemy) {
                    if (!this.myAlliance) return '';
                    const ratio = enemy.TotalPower / this.myAlliance.TotalPower;
                    if (ratio > 1.3) return 'EXTREME RISK';
                    if (ratio > 1.1) return 'TOUGH';
                    if (ratio < 0.7) return 'EASY VICTORY';
                    return 'FAIR MATCH';
                },

                getMatchColor(enemy) {
                    const res = this.calculateMatch(enemy);
                    if (res === 'EXTREME RISK') return 'text-red-600';
                    if (res === 'TOUGH') return 'text-orange-500';
                    if (res === 'EASY VICTORY') return 'text-emerald-500';
                    return 'text-cyan-400';
                },

                getThreat(enemy) {
                    const p = Number(enemy.TotalPower);
                    if (p > 800000000) return 'ðŸ”´ OVERLORD';
                    if (p > 500000000) return 'ðŸŸ  COLOSSUS';
                    return 'ðŸŸ¡ STANDARD';
                }
            }
        }
    </script>
</body>
</html>
